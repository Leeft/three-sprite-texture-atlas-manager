"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};!function(t,e){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.threeSpriteAtlasTextureManager=e()}(void 0,function(){var t=function(){function t(e,i,r,n){_classCallCheck(this,t),this.left=Math.floor("number"==typeof e&&isFinite(e)?e:0),this.top=Math.floor("number"==typeof i&&isFinite(i)?i:0),this.right=Math.floor("number"==typeof r&&isFinite(r)?r:0),this.bottom=Math.floor("number"==typeof n&&isFinite(n)?n:0)}return _createClass(t,[{key:"Xcentre",get:function(){return Math.floor((this.right-this.left)/2+this.left)-.5}},{key:"Ycentre",get:function(){return Math.floor((this.bottom-this.top)/2+this.top)-.5}},{key:"width",get:function(){return this.right-this.left}},{key:"height",get:function(){return this.bottom-this.top}}]),t}(),e=function(){function e(i){_classCallCheck(this,e),this.knapsack=i,this.leftChild=null,this.rightChild=null,this.rectangle=null,this.rectangle=new t(0,0,i.textureSize,i.textureSize),this.imageID=null,this._texture=null}return _createClass(e,[{key:"hasChildren",value:function(){return null!==this.leftChild||null!==this.rightChild}},{key:"isOccupied",value:function(){return null!==this.imageID}},{key:"uvCoordinates",value:function(){var t=this.knapsack.textureSize;return[this.rectangle.left/t,1-this.rectangle.bottom/t,this.rectangle.right/t,1-this.rectangle.top/t]}},{key:"release",value:function(){if(this.hasChildren())throw new Error("Can not release tree node, still has children");null!==this._texture&&(this._texture.dispose(),this._texture=null),this.clear(),this.imageID=null}},{key:"clear",value:function(){this.context.clearRect(this.rectangle.left,this.rectangle.top,this.width-1,this.height-1)}},{key:"clipContext",value:function(){var t=this.context;return t.save(),t.beginPath(),t.rect(this.rectangle.left+1,this.rectangle.top+1,this.width-2,this.height-2),t.clip(),t.translate(this.rectangle.Xcentre,this.rectangle.Ycentre),t}},{key:"restoreContext",value:function(){this.context.restore()}},{key:"allocate",value:function(i,r){if(this.hasChildren()){var n=this.leftChild.allocate(i,r);return n instanceof e?(n.claim(),n):this.rightChild.allocate(i,r)}if(this.isOccupied())return null;if(i>this.width||r>this.height)return null;if(i===this.width&&r===this.height)return this.claim(),this;this.leftChild=new e(this.knapsack),this.rightChild=new e(this.knapsack);var h=this.width-i,s=this.height-r;if(h>s?(this.leftChild.rectangle=new t(this.rectangle.left,this.rectangle.top,this.rectangle.left+i,this.rectangle.bottom),this.rightChild.rectangle=new t(this.rectangle.left+i,this.rectangle.top,this.rectangle.right,this.rectangle.bottom)):(this.leftChild.rectangle=new t(this.rectangle.left,this.rectangle.top,this.rectangle.right,this.rectangle.top+r),this.rightChild.rectangle=new t(this.rectangle.left,this.rectangle.top+r,this.rectangle.right,this.rectangle.bottom)),this.knapsack.textureManager.debug){var a=this.context;a.lineWidth=4,a.strokeStyle="rgba(255,0,0,1)",a.strokeRect(this.leftChild.rectangle.left,this.leftChild.rectangle.top,this.leftChild.width,this.leftChild.height),a.lineWidth=4,a.strokeStyle="rgba(0,255,0,1)",a.strokeRect(this.rightChild.rectangle.left,this.rightChild.rectangle.top,this.rightChild.width,this.rightChild.height)}return this.leftChild.allocate(i,r)}},{key:"claim",value:function(){if(this.imageID=THREE.Math.generateUUID(),this.knapsack.textureManager.debug){var t=this.context;t.lineWidth=2,t.strokeStyle="rgba( 0, 0, 255, 1 )",t.strokeRect(this.rectangle.left+.5,this.rectangle.top+.5,this.width-1,this.height-1)}}},{key:"canvas",get:function(){return this.knapsack.canvas}},{key:"context",get:function(){return this.knapsack.canvas.getContext("2d")}},{key:"width",get:function(){return this.rectangle.width}},{key:"height",get:function(){return this.rectangle.height}},{key:"texture",get:function(){if(!this._texture){this._texture=this.knapsack.rootTexture.clone(),this._texture.uuid=this.knapsack.rootTexture.uuid;var t=this.uvCoordinates();this.texture.offset.x=t[0],this.texture.offset.y=t[1],this.texture.repeat.x=t[2]-t[0],this.texture.repeat.y=t[3]-t[1]}return this._texture}}]),e}(),i=function(){function t(i,r){_classCallCheck(this,t),this.textureManager=i,this.textureSize=r,this.textureLoaded=!1,this.rootNode=new e(this),this._rootTexture=null,this._canvas=null}return _createClass(t,[{key:"allocateNode",value:function(t,e){return this.rootNode.allocate(t,e)}},{key:"canvas",get:function(){return this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=this.textureSize,this._canvas.height=this.textureSize),this._canvas}},{key:"rootTexture",get:function(){return this._rootTexture||(this._rootTexture=new THREE.Texture(this.canvas,THREE.UVMapping)),this._rootTexture}}]),t}(),r=function(){function t(e){_classCallCheck(this,t),this.size="number"==typeof e&&/^(128|256|512|1024|2048|4096|8192|16384)$/.test(e)?e:1024,this.knapsacks=[],this.debug=!1}return _createClass(t,[{key:"_addKnapsack",value:function(t){var e=new i(this,t);return this.knapsacks.push(e),this.debug&&console.log("TextureManager: allocated "+this.textureSize+"px texture map #"+this.knapsacks.length),e}},{key:"allocate",value:function(t,e){return this._validateSize(t,e),this._allocate(t,e)}},{key:"allocateNode",value:function(t,e){var i=this;return new Promise(function(r,n){try{i._validateSize(t,e),r(i._allocate(t,e))}catch(t){n(t)}})}},{key:"allocateASync",value:function(t,e){var i=this;Array.isArray(this._queue)||(this._queue=[]);var r=void 0,n=new Promise(function(n,h){try{i._validateSize(t,e),r={resolve:n,reject:h,width:t,height:e}}catch(t){h(t)}});return r&&(r.promise=n,this._queue.push(r)),n}},{key:"solveASync",value:function(){var t=this;if(!Array.isArray(this._queue))throw new Error("You're trying to resolve a queue which hasn't been set up. Call allocateASync before using this.");var e=[];return this._queue.forEach(function(i){var r=i.promise,n=i.resolve,h=(i.reject,i.width),s=i.height,a=t._allocate(h,s);n(a),e.push(r)}),this._queue=[],Promise.all(e)}},{key:"_validateSize",value:function(t,e){if(t>this.textureSize)throw new Error("Width of "+t+" is too large for these textures");if(e>this.textureSize)throw new Error("Height of "+e+" is too large for these textures")}},{key:"_allocate",value:function(t,e){var i=null;if(this.knapsacks.forEach(function(r){null!==i&&void 0!==i||(i=r.allocateNode(t,e))}),null===i){var r=this._addKnapsack(this.textureSize);i=r.allocateNode(t,e)}return i}},{key:"release",value:function(t){t&&t.release()}},{key:"textureSize",get:function(){return this.size}}]),t}();return r});
//# sourceMappingURL=three-sprite-texture-atlas-manager.umd.min.js.map
