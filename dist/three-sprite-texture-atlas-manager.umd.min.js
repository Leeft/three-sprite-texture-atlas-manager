!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("three/build/three.js")):"function"==typeof define&&define.amd?define(["three/build/three.js"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).threeSpriteAtlasTextureManager=e(t.THREE)}(this,(function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function r(t,e,r){return e&&i(t.prototype,e),r&&i(t,r),t}var n=function(){function t(i,r,n,h){e(this,t),this.left=Math.floor("number"==typeof i&&isFinite(i)?i:0),this.top=Math.floor("number"==typeof r&&isFinite(r)?r:0),this.right=Math.floor("number"==typeof n&&isFinite(n)?n:0),this.bottom=Math.floor("number"==typeof h&&isFinite(h)?h:0)}return r(t,[{key:"Xcentre",get:function(){return Math.floor((this.right-this.left)/2+this.left)-.5}},{key:"Ycentre",get:function(){return Math.floor((this.bottom-this.top)/2+this.top)-.5}},{key:"width",get:function(){return this.right-this.left}},{key:"height",get:function(){return this.bottom-this.top}}]),t}(),h=function(){function i(t){e(this,i),this.knapsack=t,this.leftChild=null,this.rightChild=null,this.rectangle=null,this.rectangle=new n(0,0,t.textureSize,t.textureSize),this.imageID=null,this._texture=null}return r(i,[{key:"canvas",get:function(){return this.knapsack.canvas}},{key:"context",get:function(){return this.knapsack.canvas.getContext("2d")}},{key:"width",get:function(){return this.rectangle.width}},{key:"height",get:function(){return this.rectangle.height}},{key:"texture",get:function(){if(!this._texture){this._texture=this.knapsack.rootTexture.clone(),this._texture.uuid=this.knapsack.rootTexture.uuid;var t=this.uvCoordinates();this.texture.offset.x=t[0],this.texture.offset.y=t[1],this.texture.repeat.x=t[2]-t[0],this.texture.repeat.y=t[3]-t[1]}return this._texture}},{key:"hasChildren",value:function(){return null!==this.leftChild||null!==this.rightChild}},{key:"isOccupied",value:function(){return null!==this.imageID}},{key:"uvCoordinates",value:function(){var t=this.knapsack.textureSize;return[this.rectangle.left/t,1-this.rectangle.bottom/t,this.rectangle.right/t,1-this.rectangle.top/t]}},{key:"release",value:function(){if(this.hasChildren())throw new Error("Can not release tree node, still has children");null!==this._texture&&(this._texture.dispose(),this._texture=null),this.clear(),this.imageID=null}},{key:"clear",value:function(){this.context.clearRect(this.rectangle.left,this.rectangle.top,this.width-1,this.height-1)}},{key:"clipContext",value:function(){var t=this.context;return t.save(),t.beginPath(),t.rect(this.rectangle.left+1,this.rectangle.top+1,this.width-2,this.height-2),t.clip(),t.translate(this.rectangle.Xcentre,this.rectangle.Ycentre),t}},{key:"restoreContext",value:function(){this.context.restore()}},{key:"allocate",value:function(t,e){if(this.hasChildren()){var r=this.leftChild.allocate(t,e);return r instanceof i?(r.claim(),r):this.rightChild.allocate(t,e)}if(this.isOccupied())return null;if(t>this.width||e>this.height)return null;if(t===this.width&&e===this.height)return this.claim(),this;if(this.leftChild=new i(this.knapsack),this.rightChild=new i(this.knapsack),this.width-t>this.height-e?(this.leftChild.rectangle=new n(this.rectangle.left,this.rectangle.top,this.rectangle.left+t,this.rectangle.bottom),this.rightChild.rectangle=new n(this.rectangle.left+t,this.rectangle.top,this.rectangle.right,this.rectangle.bottom)):(this.leftChild.rectangle=new n(this.rectangle.left,this.rectangle.top,this.rectangle.right,this.rectangle.top+e),this.rightChild.rectangle=new n(this.rectangle.left,this.rectangle.top+e,this.rectangle.right,this.rectangle.bottom)),this.knapsack.textureManager.debug){var h=this.context;h.lineWidth=4,h.strokeStyle="rgba(255,0,0,1)",h.strokeRect(this.leftChild.rectangle.left,this.leftChild.rectangle.top,this.leftChild.width,this.leftChild.height),h.lineWidth=4,h.strokeStyle="rgba(0,255,0,1)",h.strokeRect(this.rightChild.rectangle.left,this.rightChild.rectangle.top,this.rightChild.width,this.rightChild.height)}return this.leftChild.allocate(t,e)}},{key:"claim",value:function(){if(this.imageID=t.Math.generateUUID(),this.knapsack.textureManager.debug){var e=this.context;e.lineWidth=2,e.strokeStyle="rgba( 0, 0, 255, 1 )",e.strokeRect(this.rectangle.left+.5,this.rectangle.top+.5,this.width-1,this.height-1)}}}]),i}(),s=function(){function i(t,r){e(this,i),this.textureManager=t,this.textureSize=r,this.textureLoaded=!1,this.rootNode=new h(this),this._rootTexture=null,this._canvas=null}return r(i,[{key:"canvas",get:function(){return this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=this.textureSize,this._canvas.height=this.textureSize),this._canvas}},{key:"rootTexture",get:function(){return this._rootTexture||(this._rootTexture=new t.Texture(this.canvas,t.UVMapping)),this._rootTexture}},{key:"allocateNode",value:function(t,e){return this.rootNode.allocate(t,e)}}]),i}();return function(){function t(i){e(this,t),this.size="number"==typeof i&&/^(128|256|512|1024|2048|4096|8192|16384)$/.test(i)?i:1024,this.knapsacks=[],this.debug=!1}return r(t,[{key:"_addKnapsack",value:function(t){var e=new s(this,t);return this.knapsacks.push(e),this.debug&&console.log("TextureManager: allocated ".concat(this.textureSize,"px texture map #").concat(this.knapsacks.length)),e}},{key:"textureSize",get:function(){return this.size}},{key:"allocate",value:function(t,e){return this._validateSize(t,e),this._allocate(t,e)}},{key:"allocateNode",value:function(t,e){var i=this;return new Promise((function(r,n){try{i._validateSize(t,e),r(i._allocate(t,e))}catch(t){n(t)}}))}},{key:"allocateASync",value:function(t,e){var i,r=this;Array.isArray(this._queue)||(this._queue=[]);var n=new Promise((function(n,h){try{r._validateSize(t,e),i={resolve:n,reject:h,width:t,height:e}}catch(t){h(t)}}));return i&&(i.promise=n,this._queue.push(i)),n}},{key:"solveASync",value:function(){var t=this;if(!Array.isArray(this._queue))throw new Error("You're trying to resolve a queue which hasn't been set up. Call allocateASync before using this.");var e=[];return this._queue.forEach((function(i){var r=i.promise,n=i.resolve;i.reject;var h=i.width,s=i.height;n(t._allocate(h,s)),e.push(r)})),this._queue=[],Promise.all(e)}},{key:"_validateSize",value:function(t,e){if(t>this.textureSize)throw new Error("Width of ".concat(t," is too large for these textures"));if(e>this.textureSize)throw new Error("Height of ".concat(e," is too large for these textures"))}},{key:"_allocate",value:function(t,e){var i=null;if(this.knapsacks.forEach((function(r){null==i&&(i=r.allocateNode(t,e))})),null===i){var r=this._addKnapsack(this.textureSize);i=r.allocateNode(t,e)}return i}},{key:"release",value:function(t){t&&t.release()}}]),t}()}));
//# sourceMappingURL=three-sprite-texture-atlas-manager.umd.min.js.map
